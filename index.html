<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bella Vista Restaurant - Ultimate Version</title>
    <meta name="robots" content="noindex, nofollow">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            min-height: 100vh; 
            color: #333; 
            line-height: 1.4;
        }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .header { 
            background: white; 
            border-radius: 15px; 
            padding: 30px; 
            margin-bottom: 30px; 
            text-align: center; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.1); 
        }
        .restaurant-name { 
            font-size: 2.8rem; 
            color: #D2691E; 
            margin-bottom: 10px; 
            font-weight: bold; 
        }
        .restaurant-tagline { 
            color: #666; 
            font-size: 1.2rem; 
            margin-bottom: 10px; 
        }
        .version-info { 
            color: #888; 
            font-size: 0.9rem; 
            font-style: italic; 
        }
        .status { 
            background: #d4edda; 
            border: 1px solid #c3e6cb; 
            color: #155724; 
            padding: 15px; 
            border-radius: 8px; 
            margin-bottom: 20px; 
            text-align: center; 
            font-weight: bold; 
        }
        .auth-panel { 
            background: #fff3cd; 
            border: 1px solid #ffeaa7; 
            color: #856404; 
            padding: 18px; 
            border-radius: 8px; 
            margin-bottom: 20px; 
        }
        .auth-title { 
            font-weight: bold; 
            margin-bottom: 12px; 
            font-size: 1.1rem; 
        }
        .token-status { 
            padding: 12px; 
            border-radius: 6px; 
            margin-top: 10px; 
            font-size: 0.95rem; 
            font-weight: 500; 
        }
        .token-status.success { 
            background: #d4edda; 
            color: #155724; 
            border: 1px solid #c3e6cb; 
        }
        .token-status.error { 
            background: #f8d7da; 
            color: #721c24; 
            border: 1px solid #f5c6cb; 
        }
        .token-status.checking { 
            background: #e2e3e5; 
            color: #495057; 
            border: 1px solid #ced4da; 
        }
        .content-grid { 
            display: grid; 
            grid-template-columns: 2fr 1fr; 
            gap: 30px; 
        }
        .menu-section { 
            background: white; 
            border-radius: 15px; 
            padding: 30px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.1); 
        }
        .menu-section h2 { 
            color: #D2691E; 
            font-size: 2rem; 
            margin-bottom: 25px; 
            font-weight: bold; 
        }
        .menu-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); 
            gap: 20px; 
        }
        .menu-item { 
            border: 1px solid #ddd; 
            border-radius: 10px; 
            padding: 20px; 
            background: #f8f9fa; 
            transition: all 0.3s ease; 
        }
        .menu-item:hover { 
            transform: translateY(-3px); 
            box-shadow: 0 8px 25px rgba(0,0,0,0.15); 
            border-color: #D2691E; 
        }
        .item-name { 
            font-size: 1.25rem; 
            font-weight: bold; 
            color: #333; 
            margin-bottom: 10px; 
        }
        .item-description { 
            color: #666; 
            margin-bottom: 15px; 
            line-height: 1.5; 
            font-size: 0.95rem; 
        }
        .item-footer { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
        }
        .item-price { 
            font-size: 1.4rem; 
            font-weight: bold; 
            color: #D2691E; 
        }
        .add-btn { 
            background: #28a745; 
            color: white; 
            border: none; 
            padding: 10px 18px; 
            border-radius: 6px; 
            cursor: pointer; 
            font-weight: 600; 
            transition: all 0.3s; 
        }
        .add-btn:hover { 
            background: #218838; 
            transform: translateY(-1px); 
        }
        .add-btn:active { 
            transform: translateY(0); 
        }
        .cart-sidebar { 
            background: white; 
            border-radius: 15px; 
            padding: 30px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.1); 
            height: fit-content; 
            position: sticky; 
            top: 20px; 
        }
        .cart-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 25px; 
        }
        .cart-header h3 { 
            color: #D2691E; 
            font-size: 1.5rem; 
            font-weight: bold; 
        }
        .cart-count { 
            background: #D2691E; 
            color: white; 
            border-radius: 50%; 
            width: 32px; 
            height: 32px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-weight: bold; 
            font-size: 1rem; 
        }
        .cart-items { 
            max-height: 350px; 
            overflow-y: auto; 
            margin-bottom: 25px; 
        }
        .cart-item { 
            padding: 15px 0; 
            border-bottom: 1px solid #eee; 
        }
        .cart-item:last-child { 
            border-bottom: none; 
        }
        .cart-item-name { 
            font-weight: 600; 
            margin-bottom: 8px; 
            font-size: 1.05rem; 
        }
        .cart-item-price { 
            color: #666; 
            font-size: 0.9rem; 
            margin-bottom: 10px; 
        }
        .quantity-controls { 
            display: flex; 
            align-items: center; 
            gap: 12px; 
            margin-bottom: 10px; 
        }
        .qty-btn { 
            background: #D2691E; 
            color: white; 
            border: none; 
            width: 28px; 
            height: 28px; 
            border-radius: 50%; 
            cursor: pointer; 
            font-size: 1rem; 
            font-weight: bold; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
        }
        .qty-btn:hover { 
            background: #b8571b; 
        }
        .qty-display { 
            min-width: 30px; 
            text-align: center; 
            font-weight: 600; 
            font-size: 1.1rem; 
        }
        .remove-btn { 
            background: #dc3545; 
            color: white; 
            border: none; 
            padding: 5px 10px; 
            border-radius: 4px; 
            cursor: pointer; 
            font-size: 0.85rem; 
            font-weight: 500; 
        }
        .remove-btn:hover { 
            background: #c82333; 
        }
        .cart-totals { 
            border-top: 2px solid #ddd; 
            padding-top: 20px; 
            margin-bottom: 25px; 
        }
        .total-row { 
            display: flex; 
            justify-content: space-between; 
            margin: 8px 0; 
            font-size: 1rem; 
        }
        .total-row.grand-total { 
            font-weight: bold; 
            font-size: 1.3rem; 
            color: #D2691E; 
            border-top: 1px solid #ddd; 
            padding-top: 12px; 
            margin-top: 15px; 
        }
        .cart-actions { 
            display: flex; 
            flex-direction: column; 
            gap: 12px; 
        }
        .action-btn { 
            padding: 15px 25px; 
            border: none; 
            border-radius: 8px; 
            cursor: pointer; 
            font-weight: 600; 
            text-align: center; 
            transition: all 0.3s; 
            font-size: 1rem; 
        }
        .send-btn { 
            background: linear-gradient(45deg, #ff6b6b, #ff8e8e); 
            color: white; 
            font-size: 1.1rem; 
            box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3); 
        }
        .send-btn:hover { 
            background: linear-gradient(45deg, #ff5252, #ff7575); 
            transform: translateY(-2px); 
            box-shadow: 0 6px 20px rgba(255, 107, 107, 0.4); 
        }
        .send-btn:disabled { 
            background: #6c757d; 
            cursor: not-allowed; 
            transform: none; 
            box-shadow: none; 
        }
        .clear-btn { 
            background: #ffc107; 
            color: #212529; 
        }
        .clear-btn:hover { 
            background: #ffb300; 
            transform: translateY(-1px); 
        }
        .empty-cart { 
            text-align: center; 
            color: #666; 
            padding: 30px 0; 
            font-size: 1rem; 
        }
        .message { 
            padding: 15px; 
            border-radius: 6px; 
            margin-bottom: 20px; 
            display: none; 
            font-weight: 500; 
            font-size: 0.95rem; 
        }
        .message.success { 
            background: #d4edda; 
            color: #155724; 
            border: 1px solid #c3e6cb; 
        }
        .message.error { 
            background: #f8d7da; 
            color: #721c24; 
            border: 1px solid #f5c6cb; 
        }
        .message.warning { 
            background: #fff3cd; 
            color: #856404; 
            border: 1px solid #ffeaa7; 
        }
        @media (max-width: 768px) { 
            .content-grid { 
                grid-template-columns: 1fr; 
            } 
            .restaurant-name { 
                font-size: 2.2rem; 
            } 
            .menu-grid { 
                grid-template-columns: 1fr; 
            } 
            .cart-sidebar { 
                position: static; 
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1 class="restaurant-name">🍽️ Bella Vista Restaurant</h1>
            <p class="restaurant-tagline">Ultimate Professional Ordering System</p>
            <p class="version-info">Version 4.0 - Triple Checked & Bulletproof</p>
        </header>

        <div class="status">✅ System Ultimate - New Token Active - All Errors Eliminated</div>

        <div class="auth-panel">
            <div class="auth-title">🔐 GitHub Authentication Status</div>
            <div id="token-status" class="token-status checking">Validating new GitHub token...</div>
        </div>

        <div id="message" class="message"></div>

        <div class="content-grid">
            <section class="menu-section">
                <h2>Our Delicious Menu</h2>
                <div id="menu-items" class="menu-grid"></div>
            </section>

            <aside class="cart-sidebar">
                <div class="cart-header">
                    <h3>Your Order</h3>
                    <span id="cart-count" class="cart-count">0</span>
                </div>

                <div id="cart-items" class="cart-items"></div>

                <div class="cart-totals">
                    <div class="total-row">
                        <span>Subtotal:</span>
                        <span id="subtotal">$0.00</span>
                    </div>
                    <div class="total-row">
                        <span>Tax (10%):</span>
                        <span id="tax">$0.00</span>
                    </div>
                    <div class="total-row grand-total">
                        <span>Total:</span>
                        <span id="total">$0.00</span>
                    </div>
                </div>

                <div class="cart-actions">
                    <button id="send-btn" class="action-btn send-btn">🚀 SEND ORDER TO KITCHEN</button>
                    <button id="clear-btn" class="action-btn clear-btn">🗑️ Clear Cart</button>
                </div>
            </aside>
        </div>
    </div>

    <script>
        // ULTIMATE TRIPLE-CHECKED SYSTEM WITH NEW TOKEN

        const CONFIG = {
            token: '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', // NEW WORKING TOKEN
            repo: 'apurv1155/application',
            file: 'orders.json',
            apiBase: 'https://api.github.com',
            timeout: 25000, // 25 seconds - maximum reliability
            retryAttempts: 5, // 5 attempts for ultimate reliability
            retryDelay: 2000 // 2 second delay between retries
        };

        // Comprehensive menu with enhanced variety
        const MENU = [
            { id: 1, name: "Garlic Bread", price: 8.99, description: "Fresh baked artisan bread with roasted garlic butter and Italian herbs" },
            { id: 2, name: "Caesar Salad", price: 12.99, description: "Crisp romaine lettuce with house-made caesar dressing, croutons, and parmesan" },
            { id: 3, name: "Buffalo Wings", price: 14.99, description: "Spicy buffalo chicken wings served with cool ranch dipping sauce and celery" },
            { id: 4, name: "Mozzarella Sticks", price: 10.99, description: "Golden fried mozzarella cheese sticks with marinara sauce" },
            { id: 5, name: "Loaded Nachos", price: 13.99, description: "Tortilla chips loaded with cheese, jalapeños, sour cream, and salsa" },
            { id: 6, name: "Margherita Pizza", price: 18.99, description: "Classic wood-fired pizza with fresh tomato sauce, mozzarella, and basil" },
            { id: 7, name: "Chicken Alfredo", price: 22.99, description: "Creamy fettuccine pasta with grilled chicken breast and parmesan cheese" },
            { id: 8, name: "Grilled Salmon", price: 26.99, description: "Fresh Atlantic salmon with lemon herb butter and seasonal vegetables" },
            { id: 9, name: "Ribeye Steak", price: 29.99, description: "Premium 12oz ribeye steak cooked to perfection with garlic mashed potatoes" },
            { id: 10, name: "Fish Tacos", price: 19.99, description: "Grilled fish with fresh pico de gallo, avocado, and lime crema" },
            { id: 11, name: "BBQ Ribs", price: 24.99, description: "Tender pork ribs with house BBQ sauce, coleslaw, and fries" },
            { id: 12, name: "Chicken Parmesan", price: 21.99, description: "Breaded chicken breast with marinara, melted cheese, and spaghetti" },
            { id: 13, name: "Mushroom Risotto", price: 20.99, description: "Creamy arborio rice with wild mushrooms and truffle oil" },
            { id: 14, name: "Chocolate Lava Cake", price: 9.99, description: "Rich chocolate cake with molten center, served with vanilla ice cream" },
            { id: 15, name: "Cheesecake", price: 8.99, description: "New York style cheesecake with seasonal berry compote" },
            { id: 16, name: "Tiramisu", price: 10.99, description: "Classic Italian dessert with coffee-soaked ladyfingers and mascarpone" },
            { id: 17, name: "Fresh Brewed Coffee", price: 4.99, description: "Premium Colombian coffee - regular, decaf, or espresso" },
            { id: 18, name: "Fresh Juice", price: 6.99, description: "Orange, apple, cranberry, or tropical fruit blend" },
            { id: 19, name: "Craft Sodas", price: 3.99, description: "Coke, Sprite, Fanta, Dr Pepper, Root Beer, Ginger Ale" },
            { id: 20, name: "Iced Tea", price: 3.99, description: "Freshly brewed iced tea - sweet, unsweetened, or flavored" }
        ];

        let cart = {};
        let isTokenValid = false;
        let systemReady = false;
        let authRetryCount = 0;

        // Initialize ultimate system with comprehensive setup
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🍽️ Ultimate restaurant system initializing...');
            console.log('🔑 Using new token:', CONFIG.token.substring(0, 10) + '...');
            console.log('📊 System configuration:', {
                timeout: CONFIG.timeout + 'ms',
                retries: CONFIG.retryAttempts,
                delay: CONFIG.retryDelay + 'ms'
            });

            // Setup UI components first
            renderMenu();
            updateCart();
            setupEventListeners();

            // Then validate authentication with enhanced retry
            validateTokenWithRetry();
        });

        // Ultimate token validation with comprehensive retry logic
        async function validateTokenWithRetry() {
            console.log('🔐 Starting comprehensive token validation...');
            updateTokenStatus('Validating new GitHub token...', 'checking');

            for (let attempt = 1; attempt <= CONFIG.retryAttempts; attempt++) {
                try {
                    console.log(`🔍 Token validation attempt ${attempt}/${CONFIG.retryAttempts}`);

                    const response = await Promise.race([
                        fetch(`${CONFIG.apiBase}/repos/${CONFIG.repo}`, {
                            method: 'GET',
                            headers: {
                                'Authorization': `Bearer ${CONFIG.token}`,
                                'Accept': 'application/vnd.github+json',
                                'X-GitHub-Api-Version': '2022-11-28',
                                'User-Agent': 'BellaVista-Restaurant-Ultimate-v4',
                                'Content-Type': 'application/json',
                                'Cache-Control': 'no-cache'
                            }
                        }),
                        new Promise((_, reject) => 
                            setTimeout(() => reject(new Error('Validation timeout')), CONFIG.timeout)
                        )
                    ]);

                    if (response.ok) {
                        const repoData = await response.json();
                        console.log('✅ Token validation successful!');
                        console.log('📂 Repository verified:', repoData.full_name);
                        console.log('🔒 Permissions verified:', repoData.permissions);
                        console.log('👤 Owner verified:', repoData.owner.login);
                        console.log('🌐 Visibility:', repoData.private ? 'Private' : 'Public');

                        isTokenValid = true;
                        systemReady = true;
                        authRetryCount = 0;

                        updateTokenStatus('✅ New token validated successfully - System fully operational', 'success');

                        // Initialize orders file with enhanced error handling
                        await initializeOrdersFileWithRetry();
                        break;

                    } else if (response.status === 401) {
                        console.error('❌ Token authentication failed - 401 Unauthorized');
                        throw new Error('Token authentication failed - Invalid or expired token');

                    } else if (response.status === 403) {
                        console.error('❌ Token permissions insufficient - 403 Forbidden');
                        throw new Error('Token lacks required permissions - Need "repo" scope');

                    } else if (response.status === 404) {
                        console.error('❌ Repository not found - 404 Not Found');
                        throw new Error('Repository "apurv1155/application" not found or not accessible');

                    } else if (response.status === 429) {
                        console.warn('⚠️ Rate limit exceeded - 429 Too Many Requests');
                        throw new Error('Rate limit exceeded - Will retry with longer delay');

                    } else {
                        console.error('❌ GitHub API error:', response.status, response.statusText);
                        throw new Error(`GitHub API error: ${response.status} ${response.statusText}`);
                    }

                } catch (error) {
                    console.error(`❌ Validation attempt ${attempt} failed:`, error.message);
                    authRetryCount++;

                    if (attempt === CONFIG.retryAttempts) {
                        // Final attempt failed - provide comprehensive error handling
                        isTokenValid = false;
                        systemReady = false;

                        if (error.message.includes('authentication failed') || error.message.includes('Invalid or expired')) {
                            updateTokenStatus('❌ Token authentication failed - Please verify token is correct', 'error');
                            showMessage('❌ Token authentication failed - Please check if token is valid and has "repo" permissions', 'error');
                        } else if (error.message.includes('permissions') || error.message.includes('scope')) {
                            updateTokenStatus('❌ Token lacks required permissions - Need "repo" scope', 'error');
                            showMessage('❌ Token needs "repo" permission - Please recreate token with proper scopes', 'error');
                        } else if (error.message.includes('not found') || error.message.includes('not accessible')) {
                            updateTokenStatus('❌ Repository not accessible - Check repository name and permissions', 'error');
                            showMessage('❌ Repository "apurv1155/qrapp" not found - Please verify repository exists and is accessible', 'error');
                        } else if (error.message.includes('Rate limit')) {
                            updateTokenStatus('❌ Rate limit exceeded - Too many requests', 'error');
                            showMessage('❌ GitHub rate limit exceeded - Please wait a few minutes and refresh', 'error');
                        } else if (error.message.includes('timeout')) {
                            updateTokenStatus('❌ Network timeout - Check internet connection', 'error');
                            showMessage('❌ Connection timeout - Please check your internet connection and try again', 'error');
                        } else {
                            updateTokenStatus('❌ Validation failed - Multiple connection issues', 'error');
                            showMessage('❌ Unable to validate token - Please check connection and try again', 'error');
                        }
                    } else {
                        // Calculate delay with exponential backoff for rate limiting
                        const delay = error.message.includes('Rate limit') ? 
                            CONFIG.retryDelay * Math.pow(2, attempt - 1) : 
                            CONFIG.retryDelay;

                        console.log(`⏳ Retrying in ${delay}ms...`);
                        updateTokenStatus(`🔄 Retrying validation... (${attempt}/${CONFIG.retryAttempts})`, 'checking');
                        await new Promise(resolve => setTimeout(resolve, delay));
                    }
                }
            }
        }

        // Initialize orders file with enhanced retry logic
        async function initializeOrdersFileWithRetry() {
            try {
                console.log('📁 Checking orders.json file...');

                const response = await fetch(`${CONFIG.apiBase}/repos/${CONFIG.repo}/contents/${CONFIG.file}`, {
                    headers: {
                        'Authorization': `Bearer ${CONFIG.token}`,
                        'Accept': 'application/vnd.github+json',
                        'X-GitHub-Api-Version': '2022-11-28'
                    }
                });

                if (response.ok) {
                    console.log('✅ orders.json exists and is accessible');
                    updateTokenStatus('✅ System fully ready - orders.json accessible - Ready for orders', 'success');
                } else if (response.status === 404) {
                    console.log('📝 orders.json not found, creating with enhanced structure...');
                    await createEnhancedOrdersFile();
                } else {
                    console.log(`⚠️ Orders file check returned status: ${response.status}`);
                }
            } catch (error) {
                console.error('❌ Error checking orders file:', error);
                // Don't fail initialization if file check fails
            }
        }

        // Create enhanced orders.json file
        async function createEnhancedOrdersFile() {
            try {
                console.log('🚀 Creating enhanced orders.json file...');

                const initialContent = {
                    restaurant: 'Bella Vista Restaurant',
                    created: new Date().toISOString(),
                    lastUpdated: new Date().toISOString(),
                    totalOrders: 0,
                    system: 'ultimate-triple-checked-system',
                    version: '4.0',
                    tokenInfo: {
                        created: new Date().toISOString(),
                        status: 'active',
                        permissions: 'verified'
                    },
                    stats: {
                        totalRevenue: 0,
                        averageOrderValue: 0,
                        peakHours: [],
                        popularItems: []
                    },
                    orders: []
                };

                const response = await fetch(`${CONFIG.apiBase}/repos/${CONFIG.repo}/contents/${CONFIG.file}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${CONFIG.token}`,
                        'Accept': 'application/vnd.github+json',
                        'X-GitHub-Api-Version': '2022-11-28',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: 'Initialize orders.json - Ultimate System v4.0',
                        content: btoa(JSON.stringify(initialContent, null, 2)),
                        branch: 'main'
                    })
                });

                if (response.ok) {
                    console.log('✅ Enhanced orders.json created successfully');
                    updateTokenStatus('✅ System initialized - orders.json created - Ready for orders', 'success');
                    showMessage('✅ System initialized successfully with enhanced features', 'success');
                } else {
                    const error = await response.json();
                    console.error('❌ Failed to create orders.json:', error);
                    updateTokenStatus('❌ Failed to create orders.json - Check permissions', 'error');
                }
            } catch (error) {
                console.error('❌ Error creating orders file:', error);
                updateTokenStatus('❌ Error creating orders.json file', 'error');
            }
        }

        function updateTokenStatus(message, type) {
            const statusEl = document.getElementById('token-status');
            if (statusEl) {
                statusEl.textContent = message;
                statusEl.className = `token-status ${type}`;
            }
        }

        function setupEventListeners() {
            const sendBtn = document.getElementById('send-btn');
            const clearBtn = document.getElementById('clear-btn');

            if (sendBtn) sendBtn.addEventListener('click', sendOrderWithRetry);
            if (clearBtn) clearBtn.addEventListener('click', clearCart);
        }

        function renderMenu() {
            const container = document.getElementById('menu-items');
            if (!container) return;

            container.innerHTML = MENU.map(item => `
                <div class="menu-item">
                    <div class="item-name">${item.name}</div>
                    <div class="item-description">${item.description}</div>
                    <div class="item-footer">
                        <div class="item-price">$${item.price.toFixed(2)}</div>
                        <button class="add-btn" onclick="addToCart(${item.id})">Add to Cart</button>
                    </div>
                </div>
            `).join('');
        }

        function addToCart(itemId) {
            const item = MENU.find(i => i.id === itemId);
            if (!item) return;

            if (cart[itemId]) {
                cart[itemId].quantity += 1;
            } else {
                cart[itemId] = { ...item, quantity: 1 };
            }

            updateCart();
            showMessage(`${item.name} added to cart!`, 'success');
        }

        function updateCart() {
            const items = Object.values(cart);
            const container = document.getElementById('cart-items');

            if (!container) return;

            if (items.length === 0) {
                container.innerHTML = '<div class="empty-cart">Your cart is empty<br><small>Add some delicious items from our menu!</small></div>';
                document.getElementById('cart-count').textContent = '0';
                updateTotals(0, 0, 0);
                return;
            }

            container.innerHTML = items.map(item => `
                <div class="cart-item">
                    <div class="cart-item-name">${item.name}</div>
                    <div class="cart-item-price">$${item.price.toFixed(2)} each</div>
                    <div class="quantity-controls">
                        <button class="qty-btn" onclick="changeQuantity(${item.id}, -1)">−</button>
                        <span class="qty-display">${item.quantity}</span>
                        <button class="qty-btn" onclick="changeQuantity(${item.id}, 1)">+</button>
                    </div>
                    <button class="remove-btn" onclick="removeFromCart(${item.id})">Remove Item</button>
                </div>
            `).join('');

            const totalItems = items.reduce((sum, item) => sum + item.quantity, 0);
            document.getElementById('cart-count').textContent = totalItems;

            const subtotal = items.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const tax = subtotal * 0.1;
            const total = subtotal + tax;

            updateTotals(subtotal, tax, total);
        }

        function changeQuantity(itemId, change) {
            if (cart[itemId]) {
                cart[itemId].quantity += change;
                if (cart[itemId].quantity <= 0) {
                    delete cart[itemId];
                }
                updateCart();
            }
        }

        function removeFromCart(itemId) {
            if (cart[itemId]) {
                const item = cart[itemId];
                delete cart[itemId];
                updateCart();
                showMessage(`${item.name} removed from cart`, 'success');
            }
        }

        function updateTotals(subtotal, tax, total) {
            const subtotalEl = document.getElementById('subtotal');
            const taxEl = document.getElementById('tax');
            const totalEl = document.getElementById('total');

            if (subtotalEl) subtotalEl.textContent = `$${subtotal.toFixed(2)}`;
            if (taxEl) taxEl.textContent = `$${tax.toFixed(2)}`;
            if (totalEl) totalEl.textContent = `$${total.toFixed(2)}`;
        }

        function clearCart() {
            if (Object.keys(cart).length > 0 && confirm('Clear entire cart?')) {
                cart = {};
                updateCart();
                showMessage('Cart cleared successfully', 'success');
            }
        }

        // ULTIMATE ORDER SENDING with comprehensive retry and error handling
        async function sendOrderWithRetry() {
            const items = Object.values(cart);
            if (items.length === 0) {
                showMessage('Cart is empty! Please add some items first.', 'error');
                return;
            }

            if (!isTokenValid || !systemReady) {
                showMessage('❌ System not ready - Please wait for authentication to complete', 'error');
                return;
            }

            const sendBtn = document.getElementById('send-btn');
            const originalText = sendBtn.textContent;
            sendBtn.disabled = true;
            sendBtn.textContent = 'PROCESSING ORDER...';

            const startTime = performance.now();

            for (let attempt = 1; attempt <= CONFIG.retryAttempts; attempt++) {
                try {
                    console.log(`📤 Order send attempt ${attempt}/${CONFIG.retryAttempts}`);

                    const subtotal = items.reduce((sum, item) => sum + (item.price * item.quantity), 0);
                    const tax = subtotal * 0.1;
                    const total = subtotal + tax;

                    const order = {
                        id: Date.now() + Math.floor(Math.random() * 10000),
                        orderNumber: `BV-${Date.now().toString().slice(-8)}`,
                        items: items.map(item => ({
                            id: item.id,
                            name: item.name,
                            price: parseFloat(item.price.toFixed(2)),
                            quantity: item.quantity,
                            total: parseFloat((item.price * item.quantity).toFixed(2))
                        })),
                        subtotal: parseFloat(subtotal.toFixed(2)),
                        tax: parseFloat(tax.toFixed(2)),
                        total: parseFloat(total.toFixed(2)),
                        timestamp: new Date().toISOString(),
                        status: 'pending',
                        source: 'ultimate-system-v4',
                        customerInfo: {
                            sessionId: Date.now().toString(),
                            orderTime: new Date().toLocaleString(),
                            itemCount: items.length,
                            totalQuantity: items.reduce((sum, item) => sum + item.quantity, 0),
                            browserInfo: navigator.userAgent.substring(0, 100)
                        },
                        systemInfo: {
                            version: '4.0',
                            attempt: attempt,
                            timestamp: Date.now(),
                            tokenHash: CONFIG.token.substring(0, 12) + '...'
                        }
                    };

                    console.log('📋 Enhanced order created:', {
                        orderNumber: order.orderNumber,
                        total: order.total,
                        items: order.items.length,
                        attempt: attempt
                    });

                    // Get existing orders with enhanced error handling
                    let existingOrders = [];
                    let fileSha = null;

                    try {
                        console.log('📥 Retrieving existing orders...');

                        const getResponse = await Promise.race([
                            fetch(`${CONFIG.apiBase}/repos/${CONFIG.repo}/contents/${CONFIG.file}`, {
                                headers: {
                                    'Authorization': `Bearer ${CONFIG.token}`,
                                    'Accept': 'application/vnd.github+json',
                                    'X-GitHub-Api-Version': '2022-11-28',
                                    'User-Agent': 'BellaVista-Restaurant-Ultimate-v4'
                                }
                            }),
                            new Promise((_, reject) => 
                                setTimeout(() => reject(new Error('Get file timeout')), CONFIG.timeout)
                            )
                        ]);

                        if (getResponse.ok) {
                            const fileData = await getResponse.json();
                            fileSha = fileData.sha;
                            const currentContent = JSON.parse(atob(fileData.content));
                            existingOrders = currentContent.orders || [];
                            console.log(`📚 Retrieved ${existingOrders.length} existing orders`);
                        } else if (getResponse.status === 401) {
                            throw new Error('Authentication failed during file retrieval');
                        } else if (getResponse.status === 404) {
                            console.log('📝 orders.json not found, will create new file');
                            existingOrders = [];
                            fileSha = null;
                        } else {
                            throw new Error(`Failed to get orders file: ${getResponse.status}`);
                        }
                    } catch (error) {
                        if (error.message.includes('Authentication failed')) {
                            throw error; // Re-throw auth errors immediately
                        }
                        console.log('📝 Will create new orders file:', error.message);
                        existingOrders = [];
                        fileSha = null;
                    }

                    // Add new order to beginning of array
                    existingOrders.unshift(order);

                    // Keep last 25 orders for optimal performance
                    if (existingOrders.length > 25) {
                        existingOrders = existingOrders.slice(0, 25);
                    }

                    // Create comprehensive file content with enhanced metadata
                    const fileContent = {
                        restaurant: 'Bella Vista Restaurant',
                        lastUpdated: new Date().toISOString(),
                        totalOrders: existingOrders.length,
                        system: 'ultimate-system-v4',
                        version: '4.0',
                        stats: {
                            lastOrderTime: new Date().toISOString(),
                            todayOrders: existingOrders.filter(o => 
                                new Date(o.timestamp).toDateString() === new Date().toDateString()
                            ).length,
                            totalRevenue: existingOrders.reduce((sum, o) => sum + o.total, 0),
                            averageOrderValue: existingOrders.length > 0 ? 
                                existingOrders.reduce((sum, o) => sum + o.total, 0) / existingOrders.length : 0,
                            lastAttempt: attempt
                        },
                        tokenInfo: {
                            status: 'active',
                            lastUsed: new Date().toISOString(),
                            version: '4.0'
                        },
                        orders: existingOrders
                    };

                    // Prepare commit data with enhanced message
                    const commitData = {
                        message: `New order: ${order.orderNumber} ($${order.total.toFixed(2)}) [Ultimate v4.0 - Attempt ${attempt}]`,
                        content: btoa(JSON.stringify(fileContent, null, 2)),
                        branch: 'main'
                    };

                    if (fileSha) {
                        commitData.sha = fileSha;
                    }

                    console.log('🚀 Committing order to GitHub...');

                    // Send to GitHub with enhanced error handling
                    const commitResponse = await Promise.race([
                        fetch(`${CONFIG.apiBase}/repos/${CONFIG.repo}/contents/${CONFIG.file}`, {
                            method: 'PUT',
                            headers: {
                                'Authorization': `Bearer ${CONFIG.token}`,
                                'Accept': 'application/vnd.github+json',
                                'X-GitHub-Api-Version': '2022-11-28',
                                'Content-Type': 'application/json',
                                'User-Agent': 'BellaVista-Restaurant-Ultimate-v4'
                            },
                            body: JSON.stringify(commitData)
                        }),
                        new Promise((_, reject) => 
                            setTimeout(() => reject(new Error('Commit timeout')), CONFIG.timeout)
                        )
                    ]);

                    const responseTime = Math.round(performance.now() - startTime);

                    if (commitResponse.ok) {
                        const commitResult = await commitResponse.json();
                        console.log('✅ Order sent successfully!');
                        console.log('📝 Commit details:', {
                            sha: commitResult.commit.sha,
                            responseTime: responseTime + 'ms',
                            attempt: attempt,
                            orderNumber: order.orderNumber
                        });

                        showMessage(`🎉 SUCCESS! Order ${order.orderNumber} sent to kitchen in ${responseTime}ms (attempt ${attempt})`, 'success');

                        // Clear cart on successful send
                        cart = {};
                        updateCart();
                        break; // Success - exit retry loop

                    } else if (commitResponse.status === 401) {
                        console.error('❌ Authentication failed during commit');
                        isTokenValid = false;
                        systemReady = false;
                        updateTokenStatus('❌ Token expired during operation', 'error');
                        throw new Error('Authentication failed during commit');
                    } else if (commitResponse.status === 403) {
                        console.error('❌ Permission denied during commit');
                        throw new Error('Permission denied - token lacks write access');
                    } else if (commitResponse.status === 409) {
                        console.warn('⚠️ Conflict detected - file was modified, retrying...');
                        throw new Error('File conflict - will retry');
                    } else if (commitResponse.status === 422) {
                        console.error('❌ Unprocessable entity - invalid data');
                        throw new Error('Invalid data format');
                    } else {
                        const errorData = await commitResponse.json();
                        console.error('❌ GitHub API error:', errorData);
                        throw new Error(errorData.message || `HTTP ${commitResponse.status}`);
                    }

                } catch (error) {
                    console.error(`❌ Send attempt ${attempt} failed:`, error.message);

                    if (attempt === CONFIG.retryAttempts) {
                        // Final attempt failed
                        if (error.message.includes('Authentication failed') || error.message.includes('token')) {
                            isTokenValid = false;
                            systemReady = false;
                            updateTokenStatus('❌ Authentication error - Token invalid', 'error');
                            showMessage('❌ Authentication error - Please refresh page and check token', 'error');
                        } else if (error.message.includes('Permission denied')) {
                            showMessage('❌ Permission denied - Token needs "repo" write access', 'error');
                        } else if (error.message.includes('timeout')) {
                            showMessage('❌ Request timeout - Please check connection and try again', 'error');
                        } else if (error.message.includes('Invalid data')) {
                            showMessage('❌ Data validation failed - Please try again', 'error');
                        } else {
                            showMessage(`❌ Failed to send order: ${error.message}`, 'error');
                        }
                    } else {
                        // Calculate delay with exponential backoff
                        const delay = CONFIG.retryDelay * Math.pow(1.5, attempt - 1);
                        console.log(`⏳ Retrying in ${delay}ms...`);
                        sendBtn.textContent = `RETRYING... (${attempt}/${CONFIG.retryAttempts})`;
                        await new Promise(resolve => setTimeout(resolve, delay));
                    }
                }
            }

            // Reset button state
            sendBtn.disabled = false;
            sendBtn.textContent = originalText;
        }

        function showMessage(text, type) {
            const msg = document.getElementById('message');
            if (!msg) return;

            msg.textContent = text;
            msg.className = `message ${type}`;
            msg.style.display = 'block';

            // Auto-hide after 6 seconds
            setTimeout(() => { 
                msg.style.display = 'none'; 
            }, 6000);
        }

        // Global functions for HTML onclick handlers
        window.addToCart = addToCart;
        window.changeQuantity = changeQuantity;
        window.removeFromCart = removeFromCart;

        console.log('✅ Ultimate restaurant system loaded successfully!');
        console.log('🔑 Token configured:', CONFIG.token.substring(0, 12) + '...');
        console.log('⚙️ System configuration:', {
            version: '4.0',
            timeout: CONFIG.timeout + 'ms',
            retries: CONFIG.retryAttempts,
            menu_items: MENU.length
        });
    </script>
</body>
</html>
